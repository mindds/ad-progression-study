---
title: "Annotation of cell types"
description: |
  The script is used to annotate the integrated dataset. The script were run on a GPU cluster.
date: "`r Sys.Date()`"
output: 
  distill::distill_article
  toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load source functions:

```{r, message=F, warning=F}
data_path <- "/autofs/space/mindds_001/projects/AbbvieSnRNASeq/data/"
scripts_path <- "/autofs/space/mindds_001/projects/AbbvieSnRNASeq/scripts/"
annie_path <- "/autofs/space/mindds_001/projects/AbbvieSnRNASeq/scripts/annie/"
plot_dir <- paste0(annie_path, "results/plots/endothelial_cells/all_regions/")

source(paste0(annie_path, "scripts/utility_scripts/plot_functions_AGB.R"))
source(paste0(annie_path, "scripts/utility_scripts/subcluster_functions_AGB.R"))
source(paste0(scripts_path, "de_functions.R"))
source(paste0(scripts_path, "additional_functions.R"))
library(patchwork)
library(scattermore)
library(plotly)

# Define paths for data input/output
rdata_path_in <- paste0(data_path, "Rdata/")
rdata_path_out <- paste0(data_path, "Rdata/annie/")
results_path <- paste0(annie_path, "results/")

brain_regions <- c("BA20", "BA46", "EC", "V1", "V2")

# Use 4 cores
ncore <- 4

# Load packages
library(Seurat)
library(data.table)
library(monocle3)
library(SeuratWrappers)
library(tidyverse)
library(cowplot)
library(RUVSeq)
library(DESeq2)
library(lme4)
library(edgeR)
library(gridExtra)
library(future)
library(ggthemes)
library(clustree)
library(biomaRt)
library(bbplot)
library(ggVennDiagram)
library(RColorBrewer)
library(grid)
library(doParallel)
library(foreach)
library(broom)
theme_set(theme_cowplot())

source("Helper_scripts/subcluster_functions_AGB.R")
source("Helper_scripts/plot_functions_AGB.R")
```

Use cluster resolution 0.1 by default to identify endothelial cells
```{r}
cluster_res <- 0.1
```

Load data
```{r}
for (brain_region in c("BA20", "BA46", "EC", "V1", "V2")) {
  load(paste0(rdata_path_out, brain_region, "_rPCA.Rdata"))
  assign("tmp", get(paste0(brain_region, "_rPCA")))
  DefaultAssay(tmp) <- "RNA"
  assign(paste0(brain_region, "_rPCA"), tmp)
  rm(tmp)
}
```

Create dimplot for each brain region at coarse resolution 0.1
```{r}
for (brain_region in brain_regions) {
  assign("reg_seurat", get(paste0(brain_region, "_rPCA")))
  plot_dir <- paste0(results_path, "plots/all_cells/", brain_region, "/")
  reg_seurat$integrated_snn_res.0.1 <- factor(reg_seurat$integrated_snn_res.0.1,  levels=sort(as.numeric(as.character(unique(reg_seurat$integrated_snn_res.0.1)))))
  
  DefaultAssay(reg_seurat) <- "integrated"
  DimPlot(reg_seurat, reduction="umap", group.by="integrated_snn_res.0.1") +
    ggtitle(brain_region) +
    theme(plot.title=element_text(hjust=0.5))
  ggsave(paste0(plot_dir, brain_region, "_DimPlot_res0.1.png"),
         width=6, height=4, units="in", dpi=300)
}
```

Visualize cell marker heatmaps at res=0.1 to identify clusters:
```{r}
cell_markers <- read.csv(paste0(annie_path, "cell_type_markers.csv"))
for (brain_region in c("BA20", "BA46", "EC", "V1", "V2")) {
  assign("reg_seurat", get(paste0(brain_region, "_rPCA")))
  plot_dir <- paste0(results_path, "plots/all_cells/", brain_region, "/")
  
  DefaultAssay(reg_seurat) <- "RNA"
  
  # Reformat clusters as factors for visualization
  reg_seurat$integrated_snn_res.0.1 <- factor(reg_seurat$integrated_snn_res.0.1,  levels=sort(as.numeric(as.character(unique(reg_seurat$integrated_snn_res.0.1)))))
  
  # Set resolution 1 clusters as cell identities
  Idents(reg_seurat) <- reg_seurat$integrated_snn_res.0.1
  
  # reg_seurat <- removd_donor_clust(reg_seurat, res=0.1)
  reg_seurat_scaled = ScaleData(reg_seurat, features = cell_markers$genes)
  
  # downsample to 500
  reg_seurat_scaled = reg_seurat_scaled[, WhichCells(reg_seurat_scaled, downsample = 500)]
  
  do_heatmap_chunk(reg_seurat_scaled, cell_markers$genes, cell_markers$group)
  n_genes = length(cell_markers$genes)
  n_subclust = length(unique(Idents(reg_seurat_scaled)))
  
  ggsave(paste0(plot_dir, brain_region, "_CellType_Marker_Heatmap_res0.1.png"),
         width = n_subclust*2, height = (n_genes * 0.1 + length(unique(cell_markers$group))*1), 
         limitsize = FALSE, units="in", dpi=300)
  
}
```

The following subclusters aren't immediately identifiable as a particular cell type:
- BA20: 6, 7
- BA46: 5, 6, 8, 12, 14
- EC: 3, 11, 14
- V1: 8, 9, 11, 13 
- V2: 5, 8, 11

Based on these cell type marker heatmaps, each subcluster was manuallu with a corresponding cell type. The cell type annotations can be found here:

"../data/cluster_cell_type_identification.csv"

```{r}
cluster_ids <- read.csv(paste0(annie_path, "cell_type_markers/cluster_cell_type_identification.csv")) %>%
  mutate(Cluster = as.character(Cluster)) %>%
  dplyr::rename("Annie_Cell_Type" = "Cell_Type")
```


Link cells with Annie's manual annotation:
```{r}
for (brain_region in brain_regions) {
  assign("reg_seurat", get(paste0(brain_region, "_rPCA")))

  if ("celltype" %in% colnames(reg_seurat@meta.data)) {
    reg_seurat$Astrid_Cell_Type <- reg_seurat$celltype
    reg_seurat$celltype <- NULL
  } else if ("ctype" %in% colnames(reg_seurat@meta.data)) {
    reg_seurat$Astrid_Cell_Type <- reg_seurat$ctype
    reg_seurat$ctype <- NULL
  }

  this_region_cluster_IDs <- cluster_ids %>%
    filter(Brain_Region==brain_region) %>%
    dplyr::rename("integrated_snn_res.0.1"="Cluster") %>%
    dplyr::select(-Brain_Region)

  seurat_obj_cluster_IDs <- reg_seurat@meta.data %>%
    dplyr::select(integrated_snn_res.0.1) %>%
    left_join(., this_region_cluster_IDs)

  reg_seurat$Annie_Cell_Type <- seurat_obj_cluster_IDs$Annie_Cell_Type
  assign(paste0(brain_region, "_rPCA"), reg_seurat)
  

  save(list=ls(pattern=(paste0(brain_region, "_rPCA"))),
       file=paste0(rdata_path_out, brain_region, "_rPCA.Rdata"))
}
```

